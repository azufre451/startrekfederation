<?php
session_start();
include('includes/app_include.php');
include('includes/validate_class.php');
include("../includes/PHPTAL/PHPTAL.php"); 
include('includes/markerClass.php');

if(isSet($_SESSION['pgID'])) PG::updatePresence($_SESSION['pgID']);
$vali = new validator();

if(isSet($_GET['sectorMap']))
{

	
	$id = $vali->numberOnly($_GET['sectorMap']);
	if($id==0) $template = new PHPTAL('TEMPLATES/chart_sector_onwarp.htm');
	else $template = new PHPTAL('TEMPLATES/chart_sector.htm');
	
	$reaa = mysql_query("SELECT mapID FROM fed_sectors WHERE sectorID = $id");
	$real = mysql_fetch_array($reaa);
	$template->chartCode = $real['mapID'];
	
	$ra = mysql_query("SELECT placeName,pointer,placeType, place_littleLogo1, placeClass FROM pg_places WHERE sector = $id AND sector <> 0");
	$places=array();
	while ($re = mysql_fetch_array($ra))
	{
		$places[] = $re;
	}
	$template->places = $places;
	
	if($id!=0){
	$markers= new MarkerCollection();
	$ra = mysql_query("SELECT placeName,pointer,placeType, place_littleLogo1, placeClass FROM pg_places WHERE sector = $id");
	
	while ($re = mysql_fetch_array($ra))
	{
		$po = explode(';',$re['pointer']);
		$markers->addMarker($po[0],$po[1],$re['placeName']);
	}
	$template->markers = $markers->getmark();
	}
		
}

else if (isSet($_GET['interfaceChart']))
{
	$res = mysql_query("SELECT sector FROM pg_places WHERE placeID = (SELECT pgLocation FROM pg_users WHERE pgID = ".$_SESSION['pgID'].")");
	if(!mysql_affected_rows()) header('Location:chart.php');
	else
	{
		$ra = mysql_fetch_array($res);
		$to = $ra['sector'];
		header("Location:chart.php?sectorMap=$to");
	}
}

else if(isSet($_GET['goer']))
{
	$goer = addslashes($_GET['goer']);
	$myR = mysql_query("SELECT sector FROM pg_places WHERE placeName = '$goer'");
	if(mysql_affected_rows() && $ra = mysql_fetch_array($myR))
		header('Location:chart.php?sectorMap='.$ra['sector']);
	else header('Location:chart.php?error=01');
}

else
$template = new PHPTAL('TEMPLATES/chart_index.htm');
$template->error = isSet($_GET['error']) ? $_GET['error'] : '';


	try 
	{
		echo $template->execute();
	}
	catch (Exception $e){
	echo $e;
	}
	
include('includes/app_declude.php');

?>